{% extends 'base.html' %}

{% block title %}{{ exam.title }} - Writing{% endblock %}

{% block content %}
<div class="py-6">
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ exam.title }} - Writing</h1>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Writing bo'limi testi</p>
      </div>
    </div>

    <!-- Added task navigation controls -->
    <div class="mb-6">
      <div class="flex items-center justify-between">
        <div class="flex space-x-2">
          {% for task in exam.writing_tasks.all %}
          <button onclick="showTask({{ forloop.counter0 }})" id="task-indicator-{{ forloop.counter0 }}"
            class="px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 
                         {% if forloop.first %}bg-black text-white dark:bg-white dark:text-black{% else %}bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600{% endif %}">
            Task {{ forloop.counter }}
          </button>
          {% endfor %}
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-400">
          <span id="current-task-info">Task 1 of {{ exam.writing_tasks.count }}</span>
        </div>
      </div>
    </div>

    <form id="examForm" method="post" class="space-y-6">
      {% csrf_token %}

      {% for task in exam.writing_tasks.all %}
      <!-- Each task is now in its own container with visibility control -->
      <div id="task-container-{{ forloop.counter0 }}" class="task-container"
        style="{% if not forloop.first %}display: none;{% endif %}">
        <!-- 50/50 split layout -->
        <div class="flex gap-6">
          <!-- Task Description - 50% width -->
          <div class="flex-1">
            <div
              class="bg-white dark:bg-black shadow rounded-lg overflow-hidden border border-gray-200 dark:border-gray-800">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">{{ task.get_task_type_display }}: 
                    {{task.title }}</h3>
                <div
                  class="prose prose-sm max-w-none text-gray-700 dark:text-gray-300 leading-relaxed select-text whitespace-pre-line mt-4">
                  {{ task.description }}
                </div>
                <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                  Minimum {{ task.min_words }} so'z | Vaqt: {{ task.time_limit }} daqiqa
                </p>
              </div>
              <div class="p-6 max-h-[80vh] overflow-y-auto">
                {% if task.image %}
                <div class="mt-6">
                  <img src="{{ task.image.url }}" alt="Task Image"
                    class="rounded-lg shadow-md w-full h-auto border border-gray-200 dark:border-gray-700">
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Writing Area - 50% width -->
          <div class="flex-1">
            <div
              class="bg-white dark:bg-black shadow rounded-lg overflow-hidden border border-gray-200 dark:border-gray-800">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
                <h4 class="text-lg font-medium text-gray-900 dark:text-white">{{ task.get_task_type_display }} - Your
                  Answer</h4>
              </div>
              <div class="p-6">
                <textarea name="task_{{ task.id }}"
                  class="w-full h-80 px-3 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-black dark:focus:border-white resize-none"
                  placeholder="Javobingizni shu yerga yozing..." data-min-words="{{ task.min_words }}"
                  data-task-id="{{ task.id }}"></textarea>

                <div class="mt-3 flex justify-between items-center text-sm">
                  <span class="text-gray-600 dark:text-gray-400">
                    So'zlar soni:
                    <span id="word-count-{{ task.id }}" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    <span class="text-gray-500 dark:text-gray-500">/ {{ task.min_words }} minimum</span>
                  </span>
                  <span id="word-status-{{ task.id }}"
                    class="px-2 py-1 text-xs rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                    Yetarli emas
                  </span>
                </div>

                <!-- Progress bar for word count visualization -->
                <div class="mt-2">
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div id="progress-bar-{{ task.id }}"
                      class="bg-yellow-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}

      <!-- Added navigation controls -->
      <div class="flex justify-between items-center mt-8">
        <button type="button" id="prev-task-btn" onclick="previousTask()"
          class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black dark:focus:ring-white"
          style="display: none;">
          <i class="fas fa-chevron-left mr-2"></i> Oldingi Task
        </button>

        <div class="flex-1"></div>

        <button type="button" id="next-task-btn" onclick="nextTask()"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 dark:bg-white dark:text-black dark:hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black dark:focus:ring-white">
          Keyingi Task <i class="fas fa-chevron-right ml-2"></i>
        </button>

        <button type="submit" id="submit-btn"
          class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 dark:bg-white dark:text-black dark:hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black"
          style="display: none;">
          <i class="fas fa-paper-plane mr-2"></i> Javoblarni yuborish
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentTaskIndex = 0;
  const totalTasks = {{ exam.writing_tasks.count }};

  function showTask(taskIndex) {
    // Hide all task containers
    document.querySelectorAll('.task-container').forEach(container => {
      container.style.display = 'none';
    });

    // Show selected task container
    document.getElementById(`task-container-${taskIndex}`).style.display = 'block';

    // Update task indicators
    document.querySelectorAll('[id^="task-indicator-"]').forEach((indicator, index) => {
      if (index === taskIndex) {
        indicator.className = 'px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 bg-black text-white dark:bg-white dark:text-black';
      } else {
        indicator.className = 'px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
      }
    });

    // Update current task info
    document.getElementById('current-task-info').textContent = `Task ${taskIndex + 1} of ${totalTasks}`;

    // Update navigation buttons
    const prevBtn = document.getElementById('prev-task-btn');
    const nextBtn = document.getElementById('next-task-btn');
    const submitBtn = document.getElementById('submit-btn');

    if (taskIndex === 0) {
      prevBtn.style.display = 'none';
    } else {
      prevBtn.style.display = 'inline-flex';
    }

    if (taskIndex === totalTasks - 1) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'inline-flex';
    } else {
      nextBtn.style.display = 'inline-flex';
      submitBtn.style.display = 'none';
    }

    currentTaskIndex = taskIndex;
  }

  function nextTask() {
    if (currentTaskIndex < totalTasks - 1) {
      showTask(currentTaskIndex + 1);
    }
  }

  function previousTask() {
    if (currentTaskIndex > 0) {
      showTask(currentTaskIndex - 1);
    }
  }

  let totalTime = 0;
  {% for task in exam.writing_tasks.all %}
  totalTime += {{ task.time_limit }};
  {% endfor %}

  // Convert to seconds and get saved progress
  let timeLeft = localStorage.getItem('examTimeLeft_{{ exam.id }}') || (totalTime * 60);
  timeLeft = parseInt(timeLeft);

  // Save exam start time if not exists
  if (!localStorage.getItem('examStartTime_{{ exam.id }}')) {
    localStorage.setItem('examStartTime_{{ exam.id }}', Date.now());
  }

  function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    // Update navbar timer
    const navbarTimer = document.getElementById('examTimeLeft');
    if (navbarTimer) {
      navbarTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    if (timeLeft <= 0) {
      document.getElementById('examForm').submit();
      return;
    }

    timeLeft--;
    localStorage.setItem('examTimeLeft_{{ exam.id }}', timeLeft);
  }

  // Update timer every second
  setInterval(updateTimer, 1000);
  updateTimer(); // Initial call

  function saveAnswer(taskId, content) {
    localStorage.setItem(`writing_answer_${taskId}`, content);
  }

  document.querySelectorAll('textarea[name^="task_"]').forEach(textarea => {
    const taskId = textarea.dataset.taskId;
    const wordCountSpan = document.getElementById(`word-count-${taskId}`);
    const wordStatusSpan = document.getElementById(`word-status-${taskId}`);
    const progressBar = document.getElementById(`progress-bar-${taskId}`);
    const minWords = parseInt(textarea.dataset.minWords);

    // Load saved content
    const savedContent = localStorage.getItem(`writing_answer_${taskId}`);
    if (savedContent) {
      textarea.value = savedContent;
      updateWordCount(); // Update count immediately
    }

    function updateWordCount() {
      const words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0);
      const wordCount = textarea.value.trim() === '' ? 0 : words.length;

      wordCountSpan.textContent = wordCount;

      // Calculate progress percentage
      const progress = Math.min((wordCount / minWords) * 100, 100);
      progressBar.style.width = `${progress}%`;

      // Update status and colors
      if (wordCount >= minWords) {
        wordCountSpan.className = 'font-medium text-green-600 dark:text-green-400';
        wordStatusSpan.className = 'px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
        wordStatusSpan.textContent = 'Yetarli';
        progressBar.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
      } else if (wordCount > minWords * 0.7) {
        wordCountSpan.className = 'font-medium text-yellow-600 dark:text-yellow-400';
        wordStatusSpan.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
        wordStatusSpan.textContent = 'Deyarli yetarli';
        progressBar.className = 'bg-yellow-600 h-2 rounded-full transition-all duration-300';
      } else {
        wordCountSpan.className = 'font-medium text-red-600 dark:text-red-400';
        wordStatusSpan.className = 'px-2 py-1 text-xs rounded-full bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
        wordStatusSpan.textContent = 'Yetarli emas';
        progressBar.className = 'bg-red-600 h-2 rounded-full transition-all duration-300';
      }
    }

    // Event listeners for real-time updates
    textarea.addEventListener('input', function () {
      updateWordCount();
      saveAnswer(taskId, this.value);
    });

    textarea.addEventListener('paste', function () {
      // Slight delay to ensure pasted content is processed
      setTimeout(updateWordCount, 10);
    });

    // Initial word count update
    updateWordCount();
  });

  document.getElementById('examForm').addEventListener('submit', function (e) {
    e.preventDefault();

    // Clear saved progress
    localStorage.removeItem('examTimeLeft_{{ exam.id }}');
    localStorage.removeItem('examStartTime_{{ exam.id }}');

    // Clear saved answers
    {% for task in exam.writing_tasks.all %}
    localStorage.removeItem('writing_answer_{{ task.id }}');
    {% endfor %}

    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Yuborilmoqda...';

    const formData = new FormData(this);

    fetch(`/attempts/submit/{{ exam.id }}/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = data.redirect_url;
        } else {
          alert('Xatolik yuz berdi: ' + data.error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Javoblarni yuborish';
        }
      })
      .catch(error => {
        alert('Xatolik yuz berdi: ' + error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Javoblarni yuborish';
      });
  });

  // Auto-save every 30 seconds
  setInterval(() => {
    document.querySelectorAll('textarea[name^="task_"]').forEach(textarea => {
      const taskId = textarea.dataset.taskId;
      saveAnswer(taskId, textarea.value);
    });
  }, 30000);

  // Save before page unload
  window.addEventListener('beforeunload', function () {
    document.querySelectorAll('textarea[name^="task_"]').forEach(textarea => {
      const taskId = textarea.dataset.taskId;
      saveAnswer(taskId, textarea.value);
    });
  });

  document.addEventListener('DOMContentLoaded', function () {
    showTask(0);
  });
</script>
{% endblock %}